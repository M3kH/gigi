<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gigi</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; background: #0a0a0a; color: #e0e0e0; height: 100vh; display: flex; }

    /* Sidebar */
    .sidebar { width: 260px; background: #111; border-right: 1px solid #222; display: flex; flex-direction: column; }
    .sidebar-header { padding: 1rem; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; }
    .sidebar-header h2 { font-size: 1rem; }
    .new-btn { background: #1a6; color: #fff; border: none; border-radius: 4px; padding: 0.3rem 0.6rem; cursor: pointer; font-size: 0.8rem; }
    .conv-list { flex: 1; overflow-y: auto; padding: 0.5rem; }
    .conv-item { padding: 0.5rem 0.75rem; border-radius: 4px; cursor: pointer; font-size: 0.85rem; color: #aaa; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .conv-item:hover { background: #1a1a1a; }
    .conv-item.active { background: #1a1a1a; color: #fff; }

    /* Status bar */
    .status-bar { padding: 0.75rem 1rem; border-top: 1px solid #222; font-size: 0.75rem; color: #666; }
    .status-dot { display: inline-block; width: 6px; height: 6px; border-radius: 50%; margin-right: 4px; }
    .status-dot.ok { background: #4a4; }
    .status-dot.warn { background: #a84; }
    .status-dot.err { background: #a44; }

    /* Chat area */
    .chat { flex: 1; display: flex; flex-direction: column; }
    .messages { flex: 1; overflow-y: auto; padding: 1rem 2rem; }
    .message { margin-bottom: 1rem; max-width: 720px; }
    .message.user { margin-left: auto; }
    .message .role { font-size: 0.75rem; color: #666; margin-bottom: 0.25rem; }
    .message .content { padding: 0.75rem 1rem; border-radius: 8px; font-size: 0.9rem; line-height: 1.5; white-space: pre-wrap; word-break: break-word; }
    .message.user .content { background: #1a3a2a; }
    .message.assistant .content { background: #141414; border: 1px solid #222; }
    .message .tool { font-size: 0.8rem; color: #886; font-family: monospace; }

    /* Input */
    .input-area { padding: 1rem 2rem; border-top: 1px solid #222; }
    .input-row { display: flex; gap: 0.5rem; max-width: 720px; }
    .input-row textarea { flex: 1; padding: 0.6rem 0.75rem; background: #141414; border: 1px solid #222; border-radius: 6px; color: #e0e0e0; font-family: system-ui, sans-serif; font-size: 0.9rem; resize: none; min-height: 42px; max-height: 200px; }
    .input-row textarea:focus { outline: none; border-color: #444; }
    .input-row button { padding: 0.6rem 1.2rem; background: #1a6; color: #fff; border: none; border-radius: 6px; cursor: pointer; white-space: nowrap; }
    .input-row button:disabled { background: #333; color: #666; }

    /* Mobile */
    @media (max-width: 640px) {
      .sidebar { display: none; }
      .messages { padding: 1rem; }
      .input-area { padding: 0.75rem; }
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="sidebar-header">
      <h2>Gigi</h2>
      <button class="new-btn" onclick="newChat()">+ New</button>
    </div>
    <div class="conv-list" id="conv-list"></div>
    <div class="status-bar" id="status-bar">
      <span class="status-dot" id="status-dot"></span>
      <span id="status-text">Connecting...</span>
      <br><a href="/setup" style="color: #666; font-size: 0.7rem;">Settings</a>
    </div>
  </div>

  <div class="chat">
    <div class="messages" id="messages"></div>
    <div class="input-area">
      <div class="input-row">
        <textarea id="input" placeholder="Talk to Gigi..." rows="1"
          onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();send()}"></textarea>
        <button id="send-btn" onclick="send()">Send</button>
      </div>
    </div>
  </div>

  <script>
    const messagesEl = document.getElementById('messages')
    const inputEl = document.getElementById('input')
    const sendBtn = document.getElementById('send-btn')
    let sending = false

    const addMessage = (role, text) => {
      const div = document.createElement('div')
      div.className = `message ${role}`
      div.innerHTML = `<div class="role">${role === 'user' ? 'You' : 'Gigi'}</div><div class="content"></div>`
      div.querySelector('.content').textContent = text
      messagesEl.appendChild(div)
      messagesEl.scrollTop = messagesEl.scrollHeight
      return div
    }

    const send = async () => {
      const text = inputEl.value.trim()
      if (!text || sending) return

      sending = true
      sendBtn.disabled = true
      inputEl.value = ''

      addMessage('user', text)
      const assistantDiv = addMessage('assistant', 'Thinking...')

      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: text })
        })
        const data = await res.json()
        if (data.error) {
          assistantDiv.querySelector('.content').textContent = `Error: ${data.error}`
        } else {
          assistantDiv.querySelector('.content').textContent = data.response
        }
      } catch (err) {
        assistantDiv.querySelector('.content').textContent = `Error: ${err.message}`
      }

      sending = false
      sendBtn.disabled = false
      inputEl.focus()
      loadConversations()
    }

    const newChat = async () => {
      await fetch('/api/conversations/new', { method: 'POST' })
      messagesEl.innerHTML = ''
      loadConversations()
    }

    const loadConversations = async () => {
      try {
        const res = await fetch('/api/conversations')
        const convs = await res.json()
        const list = document.getElementById('conv-list')
        list.innerHTML = convs.map(c =>
          `<div class="conv-item" onclick="loadChat('${c.id}')">${c.topic || c.channel} â€” ${new Date(c.created_at).toLocaleDateString()}</div>`
        ).join('')
      } catch {}
    }

    const loadChat = async (id) => {
      try {
        const res = await fetch(`/api/conversations/${id}/messages`)
        const msgs = await res.json()
        messagesEl.innerHTML = ''
        msgs.forEach(m => {
          const text = Array.isArray(m.content)
            ? m.content.filter(b => b.type === 'text').map(b => b.text).join('')
            : (typeof m.content === 'string' ? m.content : JSON.stringify(m.content))
          addMessage(m.role, text)
        })
      } catch {}
    }

    const checkStatus = async () => {
      try {
        const res = await fetch('/health')
        const status = await res.json()
        const dot = document.getElementById('status-dot')
        const text = document.getElementById('status-text')
        dot.className = `status-dot ${status.phase === 'ready' ? 'ok' : status.phase === 'partial' ? 'warn' : 'err'}`
        text.textContent = status.phase === 'ready' ? 'All systems go' : `Phase: ${status.phase}`
      } catch {
        document.getElementById('status-dot').className = 'status-dot err'
        document.getElementById('status-text').textContent = 'Disconnected'
      }
    }

    // Auto-resize textarea
    inputEl.addEventListener('input', () => {
      inputEl.style.height = 'auto'
      inputEl.style.height = Math.min(inputEl.scrollHeight, 200) + 'px'
    })

    loadConversations()
    checkStatus()
    setInterval(checkStatus, 30000)
    inputEl.focus()
  </script>
</body>
</html>
