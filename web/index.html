<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gigi</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css">
  <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/core.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/javascript.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/python.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/bash.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/json.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/typescript.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/go.min.js"></script>
  <style>
    :root {
      --bg-primary: #0a0a0a;
      --bg-secondary: #111;
      --bg-elevated: #1a1a1a;
      --border: #222;
      --text-primary: #e0e0e0;
      --text-secondary: #aaa;
      --text-muted: #666;
      --accent-green: #1a6;
      --status-open: #4a4;
      --status-active: #ca4;
      --status-closed: #666;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; background: var(--bg-primary); color: var(--text-primary); height: 100vh; display: flex; }

    /* Sidebar */
    .sidebar { width: 280px; background: var(--bg-secondary); border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; }
    .sidebar-header { padding: 1rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .sidebar-header h2 { font-size: 1rem; }
    .new-btn { background: var(--accent-green); color: #fff; border: none; border-radius: 4px; padding: 0.3rem 0.6rem; cursor: pointer; font-size: 0.8rem; }
    .new-btn:hover { opacity: 0.9; }
    .conv-list { flex: 1; overflow-y: auto; padding: 0.5rem; }

    .conv-item { padding: 0.6rem 0.75rem; border-radius: 6px; cursor: pointer; margin-bottom: 2px; transition: background 0.15s; }
    .conv-item:hover { background: var(--bg-elevated); }
    .conv-item.active { background: var(--bg-elevated); }
    .conv-item-header { display: flex; align-items: center; gap: 0.4rem; }
    .conv-item-title { font-size: 0.85rem; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; }
    .conv-item.active .conv-item-title { color: var(--text-primary); }
    .conv-item-spinner { font-size: 0.75rem; animation: spin 1s linear infinite; display: none; }
    .conv-item-spinner.visible { display: inline; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .conv-item-tags { display: flex; gap: 0.3rem; margin-top: 0.2rem; flex-wrap: wrap; }
    .conv-tag { font-size: 0.65rem; color: var(--text-muted); background: #1a1a1a; padding: 0.1rem 0.35rem; border-radius: 3px; }

    .status-badge { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    .status-badge.open { background: var(--status-open); }
    .status-badge.active { background: var(--status-active); }
    .status-badge.closed { background: var(--status-closed); }

    /* Status bar */
    .status-bar { padding: 0.75rem 1rem; border-top: 1px solid var(--border); font-size: 0.75rem; color: var(--text-muted); }
    .status-dot { display: inline-block; width: 6px; height: 6px; border-radius: 50%; margin-right: 4px; }
    .status-dot.ok { background: var(--status-open); }
    .status-dot.warn { background: var(--status-active); }
    .status-dot.err { background: #a44; }

    /* Hamburger menu */
    .menu-btn { display: none; position: fixed; top: 0.75rem; left: 0.75rem; z-index: 1000; background: var(--bg-elevated); border: 1px solid #333; border-radius: 4px; padding: 0.5rem; cursor: pointer; }
    .menu-btn span { display: block; width: 20px; height: 2px; background: var(--text-primary); margin: 4px 0; }

    /* Chat area */
    .chat { flex: 1; display: flex; flex-direction: column; min-width: 0; }
    .chat-header { padding: 0.75rem 2rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 0.75rem; min-height: 52px; }
    .chat-title-wrap { flex: 1; display: flex; align-items: center; gap: 0.5rem; min-width: 0; }
    .chat-title { font-size: 1rem; font-weight: 500; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .chat-title-input { font-size: 1rem; font-weight: 500; background: var(--bg-elevated); border: 1px solid #444; border-radius: 4px; color: var(--text-primary); padding: 0.15rem 0.5rem; width: 100%; display: none; }
    .chat-title-edit { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 0.75rem; padding: 0.2rem 0.4rem; border-radius: 3px; flex-shrink: 0; }
    .chat-title-edit:hover { color: var(--text-secondary); background: var(--bg-elevated); }
    .stop-btn { background: #a44; color: #fff; border: none; border-radius: 4px; padding: 0.3rem 0.75rem; cursor: pointer; font-size: 0.8rem; display: none; flex-shrink: 0; }
    .stop-btn:hover { background: #c55; }
    .stop-btn.visible { display: block; }
    .browser-btn { background: #456; color: #fff; border: none; border-radius: 4px; padding: 0.3rem 0.75rem; cursor: pointer; font-size: 0.8rem; flex-shrink: 0; }
    .browser-btn:hover { background: #567; }
    .chat-header-tags { display: flex; gap: 0.3rem; flex-shrink: 0; }
    .chat-header-tag { font-size: 0.7rem; color: var(--text-muted); background: var(--bg-elevated); padding: 0.15rem 0.4rem; border-radius: 3px; }

    .messages { flex: 1; overflow-y: auto; padding: 1rem 2rem; }
    .message { margin-bottom: 1.5rem; max-width: 720px; }
    .message.user { margin-left: auto; }
    .message .meta { display: flex; gap: 0.5rem; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem; align-items: center; }
    .message .role { font-weight: 500; }
    .message .content { padding: 0.75rem 1rem; border-radius: 8px; font-size: 0.9rem; line-height: 1.6; }
    .message.user .content { background: #1a3a2a; }
    .message.assistant .content { background: #141414; border: 1px solid var(--border); }

    /* Markdown styling */
    .message .content p { margin: 0.5em 0; }
    .message .content p:first-child { margin-top: 0; }
    .message .content p:last-child { margin-bottom: 0; }
    .message .content ul, .message .content ol { margin: 0.5em 0; padding-left: 1.5em; }
    .message .content li { margin: 0.25em 0; }
    .message .content pre { background: var(--bg-primary); border: 1px solid #333; border-radius: 4px; padding: 0.75rem; margin: 0.5em 0; overflow-x: auto; }
    .message .content code { font-family: 'Monaco', 'Courier New', monospace; font-size: 0.85em; }
    .message .content pre code { font-size: 0.8em; }
    .message .content:not(pre) > code { background: var(--bg-elevated); padding: 0.1em 0.3em; border-radius: 3px; }
    .message .content blockquote { border-left: 3px solid #444; padding-left: 1em; margin: 0.5em 0; color: #999; }
    .message .content h1, .message .content h2, .message .content h3 { margin: 1em 0 0.5em 0; }
    .message .content h1 { font-size: 1.3em; }
    .message .content h2 { font-size: 1.2em; }
    .message .content h3 { font-size: 1.1em; }
    .message .content a { color: #5a9fd4; text-decoration: none; }
    .message .content a:hover { text-decoration: underline; }

    /* Tool blocks */
    .tool-block { margin: 0.5rem 0; border: 1px solid #2a2a2a; border-radius: 6px; font-size: 0.8rem; overflow: hidden; }
    .tool-header { display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0.75rem; background: #151515; cursor: pointer; user-select: none; color: var(--text-secondary); }
    .tool-header:hover { background: #1a1a1a; }
    .tool-arrow { font-size: 0.65rem; transition: transform 0.15s; color: var(--text-muted); }
    .tool-arrow.open { transform: rotate(90deg); }
    .tool-name { font-weight: 600; color: #7a8a6a; }
    .tool-summary { flex: 1; color: var(--text-muted); font-family: 'Monaco', 'Courier New', monospace; font-size: 0.75rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .tool-elapsed { color: var(--text-muted); font-size: 0.7rem; flex-shrink: 0; }
    .tool-status { font-size: 0.7rem; flex-shrink: 0; }
    .tool-status.running { color: var(--status-active); }
    .tool-status.done { color: var(--status-open); }
    .tool-body { display: none; border-top: 1px solid #2a2a2a; }
    .tool-body.open { display: block; }
    .tool-body pre { margin: 0; padding: 0.5rem 0.75rem; background: #0d0d0d; font-size: 0.75rem; overflow-x: auto; max-height: 300px; overflow-y: auto; color: var(--text-secondary); }
    .tool-body .tool-label { font-size: 0.65rem; color: var(--text-muted); padding: 0.3rem 0.75rem 0; text-transform: uppercase; letter-spacing: 0.05em; }

    /* Typing indicator */
    .typing-indicator { display: inline-flex; gap: 4px; padding: 0.75rem 1rem; }
    .typing-indicator span { width: 6px; height: 6px; background: var(--text-muted); border-radius: 50%; animation: typing 1.4s infinite; }
    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typing {
      0%, 60%, 100% { opacity: 0.3; transform: translateY(0); }
      30% { opacity: 1; transform: translateY(-6px); }
    }

    /* Input */
    .input-area { padding: 1rem 2rem; border-top: 1px solid var(--border); }
    .input-row { display: flex; gap: 0.5rem; max-width: 720px; }
    .input-row textarea { flex: 1; padding: 0.6rem 0.75rem; background: #141414; border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-family: system-ui, sans-serif; font-size: 0.9rem; resize: none; min-height: 42px; max-height: 200px; }
    .input-row textarea:focus { outline: none; border-color: #444; }
    .input-row button { padding: 0.6rem 1.2rem; background: var(--accent-green); color: #fff; border: none; border-radius: 6px; cursor: pointer; white-space: nowrap; }
    .input-row button:disabled { background: #333; color: var(--text-muted); cursor: not-allowed; }

    /* Empty state */
    .empty-state { flex: 1; display: flex; align-items: center; justify-content: center; color: var(--text-muted); font-size: 0.9rem; }

    /* Browser modal */
    .browser-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; display: none; }
    .browser-modal.visible { display: flex; align-items: center; justify-content: center; }
    .browser-container { width: 90vw; height: 85vh; max-width: 1400px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 8px; display: flex; flex-direction: column; position: relative; }
    .browser-header { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1rem; border-bottom: 1px solid var(--border); }
    .browser-header h3 { margin: 0; font-size: 1rem; color: var(--text-primary); }
    .browser-close { background: none; border: none; color: var(--text-secondary); font-size: 1.5rem; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 4px; }
    .browser-close:hover { background: var(--bg-elevated); color: var(--text-primary); }
    .browser-frame { flex: 1; border: none; border-bottom-left-radius: 8px; border-bottom-right-radius: 8px; }

    /* Mobile */
    @media (max-width: 768px) {
      .sidebar { position: fixed; top: 0; left: -280px; height: 100vh; z-index: 999; transition: left 0.3s; }
      .sidebar.open { left: 0; }
      .menu-btn { display: block; }
      .chat-header { padding: 0.75rem 1rem 0.75rem 3.5rem; }
      .messages { padding: 1rem; }
      .input-area { padding: 0.75rem; }
      .overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 998; }
      .overlay.show { display: block; }
      .browser-container { width: 95vw; height: 90vh; }
      .browser-btn { font-size: 0.75rem; padding: 0.25rem 0.5rem; }
    }
  </style>
</head>
<body>
  <button class="menu-btn" onclick="toggleSidebar()">
    <span></span>
    <span></span>
    <span></span>
  </button>

  <div class="overlay" onclick="toggleSidebar()"></div>

  <div class="sidebar">
    <div class="sidebar-header">
      <h2>Gigi</h2>
      <button class="new-btn" onclick="newChat()">+ New</button>
    </div>
    <div class="conv-list" id="conv-list"></div>
    <div class="status-bar" id="status-bar">
      <span class="status-dot" id="status-dot"></span>
      <span id="status-text">Connecting...</span>
      <br><a href="/setup" style="color: #666; font-size: 0.7rem;">Settings</a>
    </div>
  </div>

  <div class="chat">
    <div class="chat-header">
      <div class="chat-title-wrap">
        <span class="chat-title" id="chat-title">New conversation</span>
        <input class="chat-title-input" id="chat-title-input" type="text" onkeydown="if(event.key==='Enter')Chat.saveTitle();if(event.key==='Escape')Chat.cancelTitleEdit()">
        <button class="chat-title-edit" id="chat-title-edit" onclick="Chat.editTitle()" style="display:none">edit</button>
      </div>
      <button class="stop-btn" id="stop-btn" onclick="Chat.stop()">‚èπ Stop</button>
      <button class="browser-btn" id="browser-btn" onclick="Browser.toggle()">üåê Browser</button>
      <div class="chat-header-tags" id="chat-header-tags"></div>
    </div>
    <div class="messages" id="messages">
      <div class="empty-state">Send a message to start a conversation</div>
    </div>
    <div class="input-area">
      <div class="input-row">
        <textarea id="input" placeholder="Talk to Gigi..." rows="1"
          onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();Chat.send()}"></textarea>
        <button id="send-btn" onclick="Chat.send()">Send</button>
      </div>
    </div>
  </div>

  <!-- Browser Modal -->
  <div class="browser-modal" id="browser-modal" onclick="Browser.handleBackdropClick(event)">
    <div class="browser-container">
      <div class="browser-header">
        <h3>Browser Control</h3>
        <button class="browser-close" onclick="Browser.close()">√ó</button>
      </div>
      <iframe class="browser-frame" id="browser-frame" src="https://browser.cluster.local"></iframe>
    </div>
  </div>

  <script>
    // Configure marked
    marked.setOptions({
      highlight: (code, lang) => {
        if (lang && hljs.getLanguage(lang)) return hljs.highlight(code, { language: lang }).value
        return hljs.highlightAuto(code).value
      },
      breaks: true,
      gfm: true
    })

    // ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const State = {
      conversations: [],
      activeConvId: null,
      activeConv: null,
      agentRunning: new Set(),
      currentAssistantEl: null,
      currentAssistantText: ''
    }

    // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const $ = (sel) => document.querySelector(sel)
    const $$ = (sel) => document.querySelectorAll(sel)

    const formatTime = (date) => {
      const d = new Date(date)
      const now = new Date()
      const isToday = d.toDateString() === now.toDateString()
      const timeStr = d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })
      return isToday ? timeStr : `${d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} ${timeStr}`
    }

    const toolSummary = (name, input) => {
      if (!input) return ''
      if (name === 'Bash' || name === 'bash') return (input.command || '').slice(0, 80)
      if (name === 'Read' || name === 'read_file') return input.file_path || input.path || ''
      if (name === 'Write' || name === 'write_file') return input.file_path || input.path || ''
      if (name === 'Edit') return input.file_path || ''
      if (name === 'Grep' || name === 'grep') return input.pattern || ''
      if (name === 'Glob' || name === 'glob') return input.pattern || ''
      return JSON.stringify(input).slice(0, 80)
    }

    const escapeHtml = (s) => {
      const div = document.createElement('div')
      div.textContent = s
      return div.innerHTML
    }

    // ‚îÄ‚îÄ SSE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const SSE = {
      source: null,

      connect() {
        if (SSE.source) SSE.source.close()
        // Use relative path to handle both HTTP and HTTPS properly
        SSE.source = new EventSource('/api/events')

        SSE.source.onmessage = (e) => {
          try {
            const event = JSON.parse(e.data)
            SSE.handleEvent(event)
          } catch {}
        }

        SSE.source.onerror = () => {
          $('#status-dot').className = 'status-dot err'
          $('#status-text').textContent = 'SSE disconnected'
          // EventSource auto-reconnects
        }

        SSE.source.onopen = () => {
          $('#status-dot').className = 'status-dot ok'
          $('#status-text').textContent = 'Connected'
        }
      },

      handleEvent(event) {
        const convId = event.conversationId

        switch (event.type) {
          case 'agent_start':
            State.agentRunning.add(convId)
            Sidebar.updateSpinner(convId, true)
            if (convId === State.activeConvId) {
              Chat.showTyping()
              Chat.showStopButton()
            }
            break

          case 'text_chunk':
            if (convId === State.activeConvId) {
              Chat.hideTyping()
              Chat.appendText(event.text)
            }
            break

          case 'tool_use':
            if (convId === State.activeConvId) {
              Chat.hideTyping()
              Chat.addToolBlock(event.toolUseId, event.name, event.input)
            }
            break

          case 'tool_result':
            if (convId === State.activeConvId) {
              Chat.updateToolResult(event.toolUseId, event.result)
            }
            break

          case 'agent_done':
            State.agentRunning.delete(convId)
            Sidebar.updateSpinner(convId, false)
            if (convId === State.activeConvId) {
              Chat.hideTyping()
              Chat.hideStopButton()
              Chat.finalizeAssistantMessage()
            }
            Sidebar.refresh()
            break

          case 'agent_stopped':
            State.agentRunning.delete(convId)
            Sidebar.updateSpinner(convId, false)
            if (convId === State.activeConvId) {
              Chat.hideTyping()
              Chat.hideStopButton()
              Chat.finalizeAssistantMessage()
            }
            Sidebar.refresh()
            break

          case 'title_update':
            Sidebar.updateTitle(convId, event.title)
            if (convId === State.activeConvId) {
              $('#chat-title').textContent = event.title
            }
            break
        }
      }
    }

    // ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const Sidebar = {
      async refresh() {
        try {
          const res = await fetch('/api/conversations')
          State.conversations = await res.json()
          Sidebar.render(State.conversations)
        } catch {}
      },

      render(conversations) {
        const list = $('#conv-list')
        list.innerHTML = conversations.map(c => {
          const isActive = c.id === State.activeConvId
          const statusClass = State.agentRunning.has(c.id) ? 'active' : (c.status || 'open')
          const title = c.topic || c.channel || 'Untitled'
          const tags = (c.tags || []).filter(Boolean)
          return `
            <div class="conv-item${isActive ? ' active' : ''}" onclick="Chat.load('${c.id}')" data-conv-id="${c.id}">
              <div class="conv-item-header">
                <span class="status-badge ${statusClass}"></span>
                <span class="conv-item-title">${escapeHtml(title)}</span>
                <span class="conv-item-spinner${State.agentRunning.has(c.id) ? ' visible' : ''}" data-spinner="${c.id}">‚ü≥</span>
              </div>
              ${tags.length ? `<div class="conv-item-tags">${tags.map(t => `<span class="conv-tag">${escapeHtml(t)}</span>`).join('')}</div>` : ''}
            </div>
          `
        }).join('')
      },

      updateSpinner(convId, on) {
        const el = document.querySelector(`[data-spinner="${convId}"]`)
        if (el) el.classList.toggle('visible', on)
        // Also update status badge
        const item = document.querySelector(`[data-conv-id="${convId}"] .status-badge`)
        if (item) {
          item.classList.remove('open', 'active', 'closed')
          item.classList.add(on ? 'active' : 'open')
        }
      },

      updateTitle(convId, title) {
        const item = document.querySelector(`[data-conv-id="${convId}"] .conv-item-title`)
        if (item) item.textContent = title
      }
    }

    // ‚îÄ‚îÄ Browser ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const Browser = {
      modal: null,
      frame: null,

      init() {
        Browser.modal = $('#browser-modal')
        Browser.frame = $('#browser-frame')
      },

      toggle() {
        if (Browser.modal.classList.contains('visible')) {
          Browser.close()
        } else {
          Browser.open()
        }
      },

      open() {
        Browser.modal.classList.add('visible')
        // Focus the iframe for keyboard shortcuts
        setTimeout(() => Browser.frame.focus(), 100)
      },

      close() {
        Browser.modal.classList.remove('visible')
      },

      handleBackdropClick(event) {
        if (event.target === Browser.modal) {
          Browser.close()
        }
      }
    }

    // ‚îÄ‚îÄ Chat ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const Chat = {
      typingEl: null,

      async load(convId) {
        State.activeConvId = convId
        State.currentAssistantEl = null
        State.currentAssistantText = ''

        const messagesEl = $('#messages')
        messagesEl.innerHTML = ''

        // Fetch conversation metadata
        try {
          const res = await fetch(`/api/conversations/${convId}`)
          State.activeConv = await res.json()
          $('#chat-title').textContent = State.activeConv.topic || 'Untitled'
          $('#chat-title-edit').style.display = ''

          // Render header tags
          const tagsEl = $('#chat-header-tags')
          const tags = (State.activeConv.tags || []).filter(Boolean)
          tagsEl.innerHTML = tags.map(t => `<span class="chat-header-tag">${escapeHtml(t)}</span>`).join('')
        } catch {}

        // Fetch messages
        try {
          const res = await fetch(`/api/conversations/${convId}/messages`)
          const msgs = await res.json()
          msgs.forEach(m => Chat.renderMessage(m))
          messagesEl.scrollTop = messagesEl.scrollHeight
        } catch {}

        // If agent is running for this conv, show typing
        if (State.agentRunning.has(convId)) {
          Chat.showTyping()
        }

        // Highlight active in sidebar
        $$('.conv-item').forEach(el => el.classList.toggle('active', el.dataset.convId === convId))

        closeSidebar()
      },

      renderMessage(msg) {
        const messagesEl = $('#messages')

        // Skip tool_result type messages (shown via tool_calls on assistant message)
        if (msg.message_type === 'tool_result') return

        if (msg.role === 'user') {
          const text = Array.isArray(msg.content)
            ? msg.content.filter(b => b.type === 'text').map(b => b.text).join('')
            : (typeof msg.content === 'string' ? msg.content : JSON.stringify(msg.content))

          const div = document.createElement('div')
          div.className = 'message user'
          div.innerHTML = `
            <div class="meta">
              <span class="role">You</span>
              <span class="timestamp">${formatTime(msg.created_at)}</span>
            </div>
            <div class="content">${escapeHtml(text)}</div>
          `
          messagesEl.appendChild(div)
          return
        }

        // Assistant message
        const text = Array.isArray(msg.content)
          ? msg.content.filter(b => b.type === 'text').map(b => b.text).join('')
          : (typeof msg.content === 'string' ? msg.content : JSON.stringify(msg.content))

        const div = document.createElement('div')
        div.className = 'message assistant'

        // Build tool blocks HTML from stored data
        let toolBlocksHtml = ''
        if (msg.tool_calls && Array.isArray(msg.tool_calls)) {
          const outputs = msg.tool_outputs || {}
          toolBlocksHtml = msg.tool_calls.map(tc => {
            const summary = toolSummary(tc.name, tc.input)
            const result = outputs[tc.toolUseId] || ''
            const inputStr = tc.input ? JSON.stringify(tc.input, null, 2) : ''
            return `
              <div class="tool-block" data-tool-use-id="${tc.toolUseId}">
                <div class="tool-header" onclick="toggleTool(this)">
                  <span class="tool-arrow">‚ñ∂</span>
                  <span class="tool-name">${escapeHtml(tc.name)}</span>
                  <span class="tool-summary">${escapeHtml(summary)}</span>
                  <span class="tool-status done">done</span>
                </div>
                <div class="tool-body">
                  <div class="tool-label">Input</div>
                  <pre>${escapeHtml(inputStr)}</pre>
                  ${result ? `<div class="tool-label">Output</div><pre>${escapeHtml(result)}</pre>` : ''}
                </div>
              </div>
            `
          }).join('')
        }

        div.innerHTML = `
          <div class="meta">
            <span class="role">Gigi</span>
            <span class="timestamp">${formatTime(msg.created_at)}</span>
          </div>
          <div class="content">${marked.parse(text)}</div>
          ${toolBlocksHtml}
        `
        messagesEl.appendChild(div)
      },

      async send() {
        const inputEl = $('#input')
        const text = inputEl.value.trim()
        if (!text) return

        const sendBtn = $('#send-btn')
        sendBtn.disabled = true
        inputEl.value = ''
        inputEl.style.height = 'auto'

        const messagesEl = $('#messages')

        // Remove empty state
        const empty = messagesEl.querySelector('.empty-state')
        if (empty) empty.remove()
        const userDiv = document.createElement('div')
        userDiv.className = 'message user'
        userDiv.innerHTML = `
          <div class="meta">
            <span class="role">You</span>
            <span class="timestamp">${formatTime(new Date())}</span>
          </div>
          <div class="content">${escapeHtml(text)}</div>
        `
        messagesEl.appendChild(userDiv)
        messagesEl.scrollTop = messagesEl.scrollHeight

        // Fire-and-forget via SSE endpoint
        try {
          await fetch('/api/chat/send', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              message: text,
              conversationId: State.activeConvId || undefined
            })
          })
        } catch (err) {
          console.error('Send failed:', err)
        }

        sendBtn.disabled = false
        inputEl.focus()

        // Refresh sidebar to pick up new conversation if needed
        setTimeout(() => Sidebar.refresh(), 500)
      },

      showTyping() {
        if (Chat.typingEl) return
        const messagesEl = $('#messages')
        Chat.typingEl = document.createElement('div')
        Chat.typingEl.className = 'message assistant'
        Chat.typingEl.id = 'typing-indicator'
        Chat.typingEl.innerHTML = `
          <div class="meta">
            <span class="role">Gigi</span>
          </div>
          <div class="content">
            <div class="typing-indicator">
              <span></span><span></span><span></span>
            </div>
          </div>
        `
        messagesEl.appendChild(Chat.typingEl)
        messagesEl.scrollTop = messagesEl.scrollHeight
      },

      hideTyping() {
        if (Chat.typingEl) {
          Chat.typingEl.remove()
          Chat.typingEl = null
        }
      },

      appendText(chunk) {
        const messagesEl = $('#messages')

        if (!State.currentAssistantEl) {
          // Create new assistant message element
          State.currentAssistantEl = document.createElement('div')
          State.currentAssistantEl.className = 'message assistant'
          State.currentAssistantEl.innerHTML = `
            <div class="meta">
              <span class="role">Gigi</span>
              <span class="timestamp">${formatTime(new Date())}</span>
            </div>
            <div class="content"></div>
          `
          messagesEl.appendChild(State.currentAssistantEl)
          State.currentAssistantText = ''
        }

        State.currentAssistantText += chunk
        const contentEl = State.currentAssistantEl.querySelector('.content')
        contentEl.innerHTML = marked.parse(State.currentAssistantText)
        messagesEl.scrollTop = messagesEl.scrollHeight
      },

      addToolBlock(toolUseId, name, input) {
        const messagesEl = $('#messages')
        const summary = toolSummary(name, input)
        const inputStr = input ? JSON.stringify(input, null, 2) : ''

        const block = document.createElement('div')
        block.className = 'tool-block'
        block.dataset.toolUseId = toolUseId
        block.innerHTML = `
          <div class="tool-header" onclick="toggleTool(this)">
            <span class="tool-arrow">‚ñ∂</span>
            <span class="tool-name">${escapeHtml(name)}</span>
            <span class="tool-summary">${escapeHtml(summary)}</span>
            <span class="tool-elapsed" data-elapsed="${toolUseId}"></span>
            <span class="tool-status running" data-tool-status="${toolUseId}">running</span>
          </div>
          <div class="tool-body">
            <div class="tool-label">Input</div>
            <pre>${escapeHtml(inputStr)}</pre>
            <div class="tool-label">Output</div>
            <pre data-tool-output="${toolUseId}">...</pre>
          </div>
        `

        // Insert after current assistant message or at end
        if (State.currentAssistantEl) {
          State.currentAssistantEl.after(block)
        } else {
          messagesEl.appendChild(block)
        }

        // Start elapsed timer
        const startTime = Date.now()
        block._elapsedTimer = setInterval(() => {
          const elapsed = ((Date.now() - startTime) / 1000).toFixed(0)
          const el = document.querySelector(`[data-elapsed="${toolUseId}"]`)
          if (el) el.textContent = `${elapsed}s`
        }, 1000)

        messagesEl.scrollTop = messagesEl.scrollHeight

        // Reset current assistant element so next text_chunk creates a new one below this tool block
        State.currentAssistantEl = null
        State.currentAssistantText = ''
      },

      updateToolResult(toolUseId, result) {
        const outputEl = document.querySelector(`[data-tool-output="${toolUseId}"]`)
        if (outputEl) {
          outputEl.textContent = result || '(no output)'
        }
        const statusEl = document.querySelector(`[data-tool-status="${toolUseId}"]`)
        if (statusEl) {
          statusEl.textContent = 'done'
          statusEl.className = 'tool-status done'
        }
        // Stop elapsed timer
        const block = document.querySelector(`[data-tool-use-id="${toolUseId}"]`)
        if (block && block._elapsedTimer) {
          clearInterval(block._elapsedTimer)
        }
      },

      updateToolProgress(toolUseId, elapsed) {
        const el = document.querySelector(`[data-elapsed="${toolUseId}"]`)
        if (el) el.textContent = `${elapsed}s`
      },

      finalizeAssistantMessage() {
        State.currentAssistantEl = null
        State.currentAssistantText = ''
      },

      editTitle() {
        const titleEl = $('#chat-title')
        const inputEl = $('#chat-title-input')
        inputEl.value = titleEl.textContent
        titleEl.style.display = 'none'
        inputEl.style.display = ''
        inputEl.focus()
        inputEl.select()
        $('#chat-title-edit').style.display = 'none'
      },

      async saveTitle() {
        const inputEl = $('#chat-title-input')
        const titleEl = $('#chat-title')
        const title = inputEl.value.trim()
        if (!title || !State.activeConvId) {
          Chat.cancelTitleEdit()
          return
        }

        try {
          await fetch(`/api/conversations/${State.activeConvId}/title`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title })
          })
        } catch {}

        titleEl.textContent = title
        Chat.cancelTitleEdit()
        Sidebar.refresh()
      },

      cancelTitleEdit() {
        $('#chat-title').style.display = ''
        $('#chat-title-input').style.display = 'none'
        $('#chat-title-edit').style.display = ''
      },

      showStopButton() {
        $('#stop-btn').classList.add('visible')
      },

      hideStopButton() {
        $('#stop-btn').classList.remove('visible')
      },

      async stop() {
        if (!State.activeConvId) return

        try {
          await fetch(`/api/conversations/${State.activeConvId}/stop`, {
            method: 'POST'
          })
          // UI will update via SSE agent_stopped event
        } catch (err) {
          console.error('Stop failed:', err)
        }
      }
    }

    // ‚îÄ‚îÄ Tool toggle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function toggleTool(headerEl) {
      const arrow = headerEl.querySelector('.tool-arrow')
      const body = headerEl.nextElementSibling
      arrow.classList.toggle('open')
      body.classList.toggle('open')
    }

    // ‚îÄ‚îÄ Sidebar toggle (mobile) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function toggleSidebar() {
      $('.sidebar').classList.toggle('open')
      $('.overlay').classList.toggle('show')
    }

    function closeSidebar() {
      $('.sidebar').classList.remove('open')
      $('.overlay').classList.remove('show')
    }

    function newChat() {
      fetch('/api/conversations/new', { method: 'POST' }).then(() => {
        State.activeConvId = null
        State.activeConv = null
        State.currentAssistantEl = null
        State.currentAssistantText = ''
        $('#messages').innerHTML = '<div class="empty-state">Send a message to start a conversation</div>'
        $('#chat-title').textContent = 'New conversation'
        $('#chat-title-edit').style.display = 'none'
        $('#chat-header-tags').innerHTML = ''
        Sidebar.refresh()
        closeSidebar()
      })
    }

    // ‚îÄ‚îÄ Health check ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const checkStatus = async () => {
      try {
        const res = await fetch('/health')
        const status = await res.json()
        const dot = $('#status-dot')
        const text = $('#status-text')
        dot.className = `status-dot ${status.phase === 'ready' ? 'ok' : status.phase === 'partial' ? 'warn' : 'err'}`
        text.textContent = status.phase === 'ready' ? 'All systems go' : `Phase: ${status.phase}`
      } catch {
        $('#status-dot').className = 'status-dot err'
        $('#status-text').textContent = 'Disconnected'
      }
    }

    // ‚îÄ‚îÄ Auto-resize textarea ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    $('#input').addEventListener('input', function() {
      this.style.height = 'auto'
      this.style.height = Math.min(this.scrollHeight, 200) + 'px'
    })

    // ‚îÄ‚îÄ Keyboard shortcuts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && Browser.modal.classList.contains('visible')) {
        Browser.close()
      }
    })

    // ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    Browser.init()
    SSE.connect()
    Sidebar.refresh()
    checkStatus()
    setInterval(checkStatus, 30000)
    $('#input').focus()
  </script>
</body>
</html>
