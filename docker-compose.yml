services:
  gigi:
    build:
      context: .
      dockerfile: Dockerfile.aio
    image: ${REGISTRY}/${IMAGE}:${TAG:-latest}
    container_name: gigi
    restart: unless-stopped
    environment:
      DATABASE_URL: ${DATABASE_URL}
      ADMIN_USER: ${ADMIN_USER:-admin}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:-admin}
      ORG_NAME: ${ORG_NAME:-idea}
      GIGI_INSTANCE_URL: ${GIGI_INSTANCE_URL:-http://localhost:3000}
      # Backup system â€” git mirror to secondary Gitea (optional)
      BACKUP_GITEA_URL: ${BACKUP_GITEA_URL:-}
      BACKUP_AUTH_METHOD: ${BACKUP_AUTH_METHOD:-mtls}
      BACKUP_GITEA_TOKEN: ${BACKUP_GITEA_TOKEN:-}
      BACKUP_INTERVAL: ${BACKUP_INTERVAL:-6h}
      BACKUP_MTLS_CERT: ${BACKUP_MTLS_CERT:-/certs/backup/client-cert.pem}
      BACKUP_MTLS_KEY: ${BACKUP_MTLS_KEY:-/certs/backup/client-key.pem}
      BACKUP_MTLS_CA: ${BACKUP_MTLS_CA:-/certs/backup/ca-cert.pem}
      NODE_EXTRA_CA_CERTS: ${BACKUP_MTLS_CA:-/certs/backup/ca-cert.pem}
    ports:
      - "3100:3000"    # Gigi web UI
      - "2222:2222"    # Gitea SSH
      - "6080:6080"    # noVNC (browser viewer)
    shm_size: "2gb"
    volumes:
      - gigi-data:/data
      - workspace:/workspace
      - ${BACKUP_CERTS_DIR:-./certs/backup}:/certs/backup:ro
    networks:
      - gigi-network
      - databases_default
      - http-entry_default
    secrets:
      - gigi_ssh_key
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    deploy:
      mode: replicated
      replicas: 1
      update_config:
        order: start-first
        failure_action: rollback
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

secrets:
  gigi_ssh_key:
    external: true

networks:
  gigi-network:
    driver: overlay
    attachable: true
  databases_default:
    external: true
  http-entry_default:
    external: true

volumes:
  gigi-data:
  workspace:
