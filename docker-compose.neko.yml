version: '3.8'

services:
  gigi-neko:
    image: m1k1o/neko:chromium
    container_name: gigi-neko
    restart: unless-stopped
    shm_size: "2gb"
    ports:
      - "8080:8080"
      - "52000-52100:52000-52100/udp"
    environment:
      NEKO_SCREEN: 1920x1080@30
      NEKO_PASSWORD: "${NEKO_PASSWORD:-neko}"
      NEKO_PASSWORD_ADMIN: "${NEKO_ADMIN_PASSWORD:-admin}"
      NEKO_EPR: 52000-52100
      NEKO_ICELITE: 1
      NEKO_NAT1TO1: "${NEKO_NAT1TO1:-}"
      NEKO_VIDEO_CODEC: h264
      NEKO_VIDEO_BITRATE: 5000
      NEKO_AUDIO_CODEC: opus
      NEKO_BROADCAST_PIPELINE: |
        ximagesrc display=%s show-pointer=true use-damage=false
        ! video/x-raw,framerate=30/1
        ! videoconvert
        ! queue
    networks:
      - gigi-network
    volumes:
      - ./browser-profiles:/home/neko/.config/chromium
    cap_add:
      - SYS_ADMIN
    security_opt:
      - seccomp:unconfined

  gigi:
    build: .
    container_name: gigi
    restart: unless-stopped
    depends_on:
      - gigi-neko
    environment:
      BROWSER_MODE: "${BROWSER_MODE:-headless}"
      NEKO_HOST: gigi-neko
      NEKO_PORT: 8080
      NEKO_PASSWORD: "${NEKO_PASSWORD:-neko}"
      WS_PORT: 3001
    ports:
      - "3000:3000"
      - "3001:3001"
    volumes:
      - ./workspace:/workspace
      - ./src:/app/src
      - ./web:/app/web
    networks:
      - gigi-network

networks:
  gigi-network:
    driver: bridge

volumes:
  browser-profiles: