# Gigi Caddyfile — Example configuration
# Replace hostnames and service names with your deployment values.
#
# Required DNS entries (or use env var overrides):
#   BROWSER_DOMAIN → browser host (Chrome noVNC)
#   GIGI_DOMAIN    → main Gigi host

{$BROWSER_DOMAIN:browser.localhost} {
	reverse_proxy {$GIGI_CHROME_SERVICE:gigi_chrome}:6080
}

{$GIGI_DOMAIN:gigi.localhost} {
	# Gitea UI proxy (iframe embedding) — routed through Hono which handles auth + prefix stripping
	# (no separate Caddy→Gitea route needed; Hono's /gitea/* handler does it)

	# Handle WebSocket connections for browser control on /ws path
	@browserws {
		path /ws
		header Connection *Upgrade*
		header Upgrade websocket
	}
	reverse_proxy @browserws {$GIGI_SERVICE:gigi_gigi}:3001

	# Ensure SSE/EventSource works properly
	@sse {
		path /api/events
	}
	handle @sse {
		reverse_proxy {$GIGI_SERVICE:gigi_gigi}:3000 {
			# Disable buffering for SSE
			flush_interval -1
			# Long timeout for persistent connections
			transport http {
				read_timeout 0
				write_timeout 0
			}
		}
	}

	# Main application (all other requests)
	reverse_proxy {$GIGI_SERVICE:gigi_gigi}:3000 {
		# Flush immediately for potential streaming responses
		flush_interval -1
	}
}
